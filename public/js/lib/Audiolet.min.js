function AudioFileRequest(e,t){this.url=e;if(typeof t=="undefined"||t==null){t=true}this.async=t;var n=e.split(".");this.extension=n[n.length-1].toLowerCase()}function Decoder(){}function WAVDecoder(e){}function AIFFDecoder(){}function AudioletDevice(e,t,n,r){AudioletNode.call(this,e,1,0);this.sink=Sink(this.tick.bind(this),n,r,t);this.sampleRate=this.sink.sampleRate;this.numberOfChannels=this.sink.channelCount;this.bufferSize=this.sink.preBufferSize;this.writePosition=0;this.buffer=null;this.paused=false;this.needTraverse=true;this.nodes=[]}function extend(e,t){function n(){}n.prototype=t.prototype;e.prototype=new n;e.prototype.constructor=e}AudioFileRequest.prototype.onSuccess=function(e){};AudioFileRequest.prototype.onFailure=function(e){};AudioFileRequest.prototype.send=function(){if(this.extension!="wav"&&this.extension!="aiff"&&this.extension!="aif"){this.onFailure();return}var e=new XMLHttpRequest;e.open("GET",this.url,this.async);e.overrideMimeType("text/plain; charset=x-user-defined");e.onreadystatechange=function(t){if(e.readyState==4){if(e.status==200||e.status==0){this.handleResponse(e.responseText)}else{this.onFailure()}}}.bind(this);e.send(null)};AudioFileRequest.prototype.handleResponse=function(e){var t,n;if(this.extension=="wav"){t=new WAVDecoder;n=t.decode(e)}else if(this.extension=="aiff"||this.extension=="aif"){t=new AIFFDecoder;n=t.decode(e)}this.onSuccess(n)};Decoder.prototype.readString=function(e,t,n){return e.slice(t,t+n)};Decoder.prototype.readIntL=function(e,t,n){var r=0;for(var i=0;i<n;i++){r=r+(e.charCodeAt(t+i)&255)*Math.pow(2,8*i)}return r};Decoder.prototype.readChunkHeaderL=function(e,t){var n={};n.name=this.readString(e,t,4);n.length=this.readIntL(e,t+4,4);return n};Decoder.prototype.readIntB=function(e,t,n){var r=0;for(var i=0;i<n;i++){r=r+(e.charCodeAt(t+i)&255)*Math.pow(2,8*(n-i-1))}return r};Decoder.prototype.readChunkHeaderB=function(e,t){var n={};n.name=this.readString(e,t,4);n.length=this.readIntB(e,t+4,4);return n};Decoder.prototype.readFloatB=function(e,t){var n=this.readIntB(e,t,2);var r=1<<16-1;if(n>=r){n|=~(r-1)}var i=1;if(n<0){i=-1;n+=r}var s=this.readIntB(e,t+2,4);var o=this.readIntB(e,t+6,4);var u;if(n==s==o==0){u=0}else if(n==32767){u=Number.MAX_VALUE}else{n-=16383;u=(s*4294967296+o)*Math.pow(2,n-63)}return i*u};WAVDecoder.prototype.__proto__=Decoder.prototype;WAVDecoder.prototype.decode=function(e){var t={};var n=0;var r=this.readChunkHeaderL(e,n);n+=8;if(r.name!="RIFF"){console.error("File is not a WAV");return null}var i=r.length;i+=8;var s=this.readString(e,n,4);n+=4;if(s!="WAVE"){console.error("File is not a WAV");return null}while(n<i){var r=this.readChunkHeaderL(e,n);n+=8;if(r.name=="fmt "){var o=this.readIntL(e,n,2);n+=2;if(o!=1){console.error("Cannot decode non-PCM encoded WAV file");return null}var u=this.readIntL(e,n,2);n+=2;var a=this.readIntL(e,n,4);n+=4;n+=4;n+=2;var f=this.readIntL(e,n,2);var l=f/8;n+=2}else if(r.name=="data"){var c=r.length/(l*u);var h=[];for(var p=0;p<u;p++){h.push(new Float32Array(c))}for(var p=0;p<u;p++){var d=h[p];for(var v=0;v<c;v++){var m=n;m+=(v*u+p)*l;var g=this.readIntL(e,m,l);var y=1<<f-1;if(g>=y){g|=~(y-1)}d[v]=g/y}}n+=r.length}else{n+=r.length}}t.sampleRate=a;t.bitDepth=f;t.channels=h;t.length=c;return t};AIFFDecoder.prototype.__proto__=Decoder.prototype;AIFFDecoder.prototype.decode=function(e){var t={};var n=0;var r=this.readChunkHeaderB(e,n);n+=8;if(r.name!="FORM"){console.error("File is not an AIFF");return null}var i=r.length;i+=8;var s=this.readString(e,n,4);n+=4;if(s!="AIFF"){console.error("File is not an AIFF");return null}while(n<i){var r=this.readChunkHeaderB(e,n);n+=8;if(r.name=="COMM"){var o=this.readIntB(e,n,2);n+=2;var u=this.readIntB(e,n,4);n+=4;var a=[];for(var f=0;f<o;f++){a.push(new Float32Array(u))}var l=this.readIntB(e,n,2);var c=l/8;n+=2;var h=this.readFloatB(e,n);n+=10}else if(r.name=="SSND"){var p=this.readIntB(e,n,4);n+=4;n+=4;n+=p;for(var f=0;f<o;f++){var d=a[f];for(var v=0;v<u;v++){var m=n;m+=(v*o+f)*c;var g=this.readIntB(e,m,c);var y=1<<l-1;if(g>=y){g|=~(y-1)}d[v]=g/y}}n+=r.length-p-8}else{n+=r.length}}t.sampleRate=h;t.bitDepth=l;t.channels=a;t.length=u;return t};var AudioletBuffer=function(e,t){this.numberOfChannels=e;this.length=t;this.channels=[];for(var n=0;n<this.numberOfChannels;n++){this.channels.push(new Float32Array(t))}this.unslicedChannels=[];for(var n=0;n<this.numberOfChannels;n++){this.unslicedChannels.push(this.channels[n])}this.isEmpty=false;this.channelOffset=0};AudioletBuffer.prototype.getChannelData=function(e){return this.channels[e]};AudioletBuffer.prototype.set=function(e){var t=e.numberOfChannels;for(var n=0;n<t;n++){this.channels[n].set(e.getChannelData(n))}};AudioletBuffer.prototype.setSection=function(e,t,n,r){n=n||0;r=r||0;var i=e.numberOfChannels;for(var s=0;s<i;s++){n+=e.channelOffset;r+=this.channelOffset;var o=this.unslicedChannels[s].subarray(r,r+t);var u=e.unslicedChannels[s].subarray(n,n+t);o.set(u)}};AudioletBuffer.prototype.add=function(e){var t=this.length;var n=e.numberOfChannels;for(var r=0;r<n;r++){var i=this.getChannelData(r);var s=e.getChannelData(r);for(var o=0;o<t;o++){i[o]+=s[o]}}};AudioletBuffer.prototype.addSection=function(e,t,n,r){n=n||0;r=r||0;var i=e.numberOfChannels;for(var s=0;s<i;s++){var o=this.getChannelData(s);var u=e.getChannelData(s);for(var a=0;a<t;a++){o[a+r]+=u[a+n]}}};AudioletBuffer.prototype.resize=function(e,t,n,r){r=r||0;var i=this.channels;var s=this.unslicedChannels;var o=this.length;var u=this.channelOffset+r;for(var a=0;a<e;a++){var f=i[a];var l=s[a];if(t>o){var c=f;if(!n||!l||l.length<t){l=new Float32Array(t)}f=l.subarray(0,t);if(!n&&c){f.set(c,r)}u=0}else{if(!l){var h=s[0].length;l=new Float32Array(h)}r=u;f=l.subarray(r,r+t)}i[a]=f;s[a]=l}this.channels=i.slice(0,e);this.unslicedChannels=s.slice(0,e);this.length=t;this.numberOfChannels=e;this.channelOffset=u};AudioletBuffer.prototype.push=function(e){var t=e.length;this.resize(this.numberOfChannels,this.length+t);this.setSection(e,t,0,this.length-t)};AudioletBuffer.prototype.pop=function(e){var t=e.length;var n=this.length-t;e.setSection(this,t,n,0);this.resize(this.numberOfChannels,n)};AudioletBuffer.prototype.unshift=function(e){var t=e.length;this.resize(this.numberOfChannels,this.length+t,false,t);this.setSection(e,t,0,0)};AudioletBuffer.prototype.shift=function(e){var t=e.length;e.setSection(this,t,0,0);this.resize(this.numberOfChannels,this.length-t,false,t)};AudioletBuffer.prototype.zero=function(){var e=this.numberOfChannels;for(var t=0;t<e;t++){var n=this.getChannelData(t);var r=this.length;for(var i=0;i<r;i++){n[i]=0}}};AudioletBuffer.prototype.combined=function(){var e=this.channels;var t=this.numberOfChannels;var n=this.length;var r=new Float32Array(t*n);for(var i=0;i<t;i++){r.set(e[i],i*n)}return r};AudioletBuffer.prototype.interleaved=function(){var e=this.channels;var t=this.numberOfChannels;var n=this.length;var r=new Float32Array(t*n);for(var i=0;i<n;i++){for(var s=0;s<t;s++){r[t*i+s]=e[s][i]}}return r};AudioletBuffer.prototype.copy=function(){var e=new AudioletBuffer(this.numberOfChannels,this.length);e.set(this);return e};AudioletBuffer.prototype.load=function(e,t,n){var r=new AudioFileRequest(e,t);r.onSuccess=function(e){this.length=e.length;this.numberOfChannels=e.channels.length;this.unslicedChannels=e.channels;this.channels=e.channels;this.channelOffset=0;if(n){n()}}.bind(this);r.onFailure=function(){console.error("Could not load",e)}.bind(this);r.send()};var AudioletGroup=function(e,t,n){this.audiolet=e;this.inputs=[];for(var r=0;r<t;r++){this.inputs.push(new PassThroughNode(this.audiolet,1,1))}this.outputs=[];for(var r=0;r<n;r++){this.outputs.push(new PassThroughNode(this.audiolet,1,1))}};AudioletGroup.prototype.connect=function(e,t,n){this.outputs[t||0].connect(e,0,n)};AudioletGroup.prototype.disconnect=function(e,t,n){this.outputs[t||0].disconnect(e,0,n)};AudioletGroup.prototype.remove=function(){var e=this.inputs.length;for(var t=0;t<e;t++){this.inputs[t].remove()}var n=this.outputs.length;for(var t=0;t<n;t++){this.outputs[t].remove()}};var AudioletDestination=function(e,t,n,r){AudioletGroup.call(this,e,1,0);this.device=new AudioletDevice(e,t,n,r);e.device=this.device;this.scheduler=new Scheduler(e);e.scheduler=this.scheduler;this.upMixer=new UpMixer(e,this.device.numberOfChannels);this.inputs[0].connect(this.scheduler);this.scheduler.connect(this.upMixer);this.upMixer.connect(this.device)};extend(AudioletDestination,AudioletGroup);AudioletDestination.prototype.toString=function(){return"Destination"};var AudioletNode=function(e,t,n,r){this.audiolet=e;this.inputs=[];for(var i=0;i<t;i++){this.inputs.push(new AudioletInput(this,i))}this.outputs=[];for(var i=0;i<n;i++){this.outputs.push(new AudioletOutput(this,i))}if(r){this.generate=r}};AudioletNode.prototype.connect=function(e,t,n){if(e instanceof AudioletGroup){e=e.inputs[n||0];n=0}var r=this.outputs[t||0];var i=e.inputs[n||0];r.connect(i);i.connect(r);this.audiolet.device.needTraverse=true};AudioletNode.prototype.disconnect=function(e,t,n){if(e instanceof AudioletGroup){e=e.inputs[n||0];n=0}var r=this.outputs[t||0];var i=e.inputs[n||0];i.disconnect(r);r.disconnect(i);this.audiolet.device.needTraverse=true};AudioletNode.prototype.setNumberOfOutputChannels=function(e,t){this.outputs[e].numberOfChannels=t};AudioletNode.prototype.linkNumberOfOutputChannels=function(e,t){this.outputs[e].linkNumberOfChannels(this.inputs[t])};AudioletNode.prototype.tick=function(){this.createInputSamples();this.createOutputSamples();this.generate()};AudioletNode.prototype.traverse=function(e){if(e.indexOf(this)==-1){e.push(this);e=this.traverseParents(e)}return e};AudioletNode.prototype.traverseParents=function(e){var t=this.inputs.length;for(var n=0;n<t;n++){var r=this.inputs[n];var i=r.connectedFrom.length;for(var s=0;s<i;s++){e=r.connectedFrom[s].node.traverse(e)}}return e};AudioletNode.prototype.generate=function(){};AudioletNode.prototype.createInputSamples=function(){var e=this.inputs.length;for(var t=0;t<e;t++){var n=this.inputs[t];var r=0;for(var i=0;i<n.connectedFrom.length;i++){var s=n.connectedFrom[i];for(var o=0;o<s.samples.length;o++){var u=s.samples[o];if(o<r){n.samples[o]+=u}else{n.samples[o]=u;r+=1}}}if(n.samples.length>r){n.samples=n.samples.slice(0,r)}}};AudioletNode.prototype.createOutputSamples=function(){var e=this.outputs.length;for(var t=0;t<e;t++){var n=this.outputs[t];var r=n.getNumberOfChannels();if(n.samples.length==r){continue}else if(n.samples.length>r){n.samples=n.samples.slice(0,r);continue}for(var i=n.samples.length;i<r;i++){n.samples[i]=0}}};AudioletNode.prototype.remove=function(){var e=this.inputs.length;for(var t=0;t<e;t++){var n=this.inputs[t];var r=n.connectedFrom.length;for(var i=0;i<r;i++){var s=n.connectedFrom[i];var o=s.node;o.disconnect(this,s.index,t)}}var u=this.outputs.length;for(var t=0;t<u;t++){var o=this.outputs[t];var r=o.connectedTo.length;for(var i=0;i<r;i++){var a=o.connectedTo[i];var n=a.node;this.disconnect(n,t,a.index)}}};extend(AudioletDevice,AudioletNode);AudioletDevice.prototype.tick=function(e,t){if(!this.paused){var n=this.inputs[0];var r=e.length/t;for(var i=0;i<r;i++){if(this.needTraverse){this.nodes=this.traverse([]);this.needTraverse=false}for(var s=this.nodes.length-1;s>0;s--){this.nodes[s].tick()}this.createInputSamples();for(var s=0;s<t;s++){e[i*t+s]=n.samples[s]}this.writePosition+=1}}};AudioletDevice.prototype.getPlaybackTime=function(){return this.sink.getPlaybackTime()};AudioletDevice.prototype.getWriteTime=function(){return this.writePosition};AudioletDevice.prototype.pause=function(){this.paused=true};AudioletDevice.prototype.play=function(){this.paused=false};AudioletDevice.prototype.toString=function(){return"Audio Output Device"};var AudioletInput=function(e,t){this.node=e;this.index=t;this.connectedFrom=[];this.samples=[]};AudioletInput.prototype.connect=function(e){this.connectedFrom.push(e)};AudioletInput.prototype.disconnect=function(e){var t=this.connectedFrom.length;for(var n=0;n<t;n++){if(e==this.connectedFrom[n]){this.connectedFrom.splice(n,1);break}}if(this.connectedFrom.length==0){this.samples=[]}};AudioletInput.prototype.toString=function(){return this.node.toString()+"Input #"+this.index};var Audiolet=function(e,t,n){this.output=new AudioletDestination(this,e,t,n)};var AudioletOutput=function(e,t){this.node=e;this.index=t;this.connectedTo=[];this.samples=[];this.linkedInput=null;this.numberOfChannels=1};AudioletOutput.prototype.connect=function(e){this.connectedTo.push(e)};AudioletOutput.prototype.disconnect=function(e){var t=this.connectedTo.length;for(var n=0;n<t;n++){if(e==this.connectedTo[n]){this.connectedTo.splice(n,1);break}}};AudioletOutput.prototype.linkNumberOfChannels=function(e){this.linkedInput=e};AudioletOutput.prototype.unlinkNumberOfChannels=function(){this.linkedInput=null};AudioletOutput.prototype.getNumberOfChannels=function(){if(this.linkedInput&&this.linkedInput.connectedFrom.length){return this.linkedInput.samples.length}return this.numberOfChannels};AudioletOutput.prototype.toString=function(){return this.node.toString()+"Output #"+this.index+" - "};var AudioletParameter=function(e,t,n){this.node=e;if(typeof t!="undefined"&&t!=null){this.input=e.inputs[t]}else{this.input=null}this.value=n||0};AudioletParameter.prototype.isStatic=function(){return this.input.samples.length==0};AudioletParameter.prototype.isDynamic=function(){return this.input.samples.length>0};AudioletParameter.prototype.setValue=function(e){this.value=e};AudioletParameter.prototype.getValue=function(){if(this.input!=null&&this.input.samples.length>0){return this.input.samples[0]}else{return this.value}};var ParameterNode=function(e,t){AudioletNode.call(this,e,1,1);this.parameter=new AudioletParameter(this,0,t)};extend(ParameterNode,AudioletNode);ParameterNode.prototype.generate=function(){this.outputs[0].samples[0]=this.parameter.getValue()};ParameterNode.prototype.toString=function(){return"Parameter Node"};var PassThroughNode=function(e,t,n){AudioletNode.call(this,e,t,n)};extend(PassThroughNode,AudioletNode);PassThroughNode.prototype.createOutputSamples=function(){var e=this.outputs.length;for(var t=0;t<e;t++){var n=this.inputs[t];var r=this.outputs[t];if(n&&n.samples.length!=0){r.samples=n.samples}else{var i=r.getNumberOfChannels();if(r.samples.length==i){continue}else if(r.samples.length>i){r.samples=r.samples.slice(0,i);continue}for(var s=r.samples.length;s<i;s++){r.samples[s]=0}}}};PassThroughNode.prototype.toString=function(){return"Pass Through Node"};var PriorityQueue=function(e,t){if(t){this.compare=t}if(e){this.heap=e;for(var n=0;n<Math.floor(this.heap.length/2);n++){this.siftUp(n)}}else{this.heap=[]}};PriorityQueue.prototype.push=function(e){this.heap.push(e);this.siftDown(0,this.heap.length-1)};PriorityQueue.prototype.pop=function(){var e,t;e=this.heap.pop();if(this.heap.length){var t=this.heap[0];this.heap[0]=e;this.siftUp(0)}else{t=e}return t};PriorityQueue.prototype.peek=function(){return this.heap[0]};PriorityQueue.prototype.isEmpty=function(){return this.heap.length==0};PriorityQueue.prototype.siftDown=function(e,t){var n=this.heap[t];while(t>e){var r=t-1>>1;var i=this.heap[r];if(this.compare(n,i)){this.heap[t]=i;t=r;continue}break}this.heap[t]=n};PriorityQueue.prototype.siftUp=function(e){var t=this.heap.length;var n=e;var r=this.heap[e];var i=2*e+1;while(i<t){var s=i+1;if(s<t&&!this.compare(this.heap[i],this.heap[s])){i=s}this.heap[e]=this.heap[i];e=i;i=2*e+1}this.heap[e]=r;this.siftDown(n,e)};PriorityQueue.prototype.compare=function(e,t){return e<t};var Scheduler=function(e,t){PassThroughNode.call(this,e,1,1);this.linkNumberOfOutputChannels(0,0);this.bpm=t||120;this.queue=new PriorityQueue(null,function(e,t){return e.time<t.time});this.time=0;this.beat=0;this.beatInBar=0;this.bar=0;this.seconds=0;this.beatsPerBar=0;this.lastBeatTime=0;this.beatLength=60/this.bpm*this.audiolet.device.sampleRate};extend(Scheduler,PassThroughNode);Scheduler.prototype.setTempo=function(e){this.bpm=e;this.beatLength=60/this.bpm*this.audiolet.device.sampleRate};Scheduler.prototype.addRelative=function(e,t){var n={};n.callback=t;n.time=this.time+e*this.beatLength;this.queue.push(n);return n};Scheduler.prototype.addAbsolute=function(e,t){if(e<this.beat||e==this.beat&&this.time>this.lastBeatTime){return null}var n={};n.callback=t;n.time=this.lastBeatTime+(e-this.beat)*this.beatLength;this.queue.push(n);return n};Scheduler.prototype.play=function(e,t,n){var r={};r.patterns=e;r.durationPattern=t;r.callback=n;r.time=this.audiolet.device.getWriteTime();this.queue.push(r);return r};Scheduler.prototype.playAbsolute=function(e,t,n,r){if(e<this.beat||e==this.beat&&this.time>this.lastBeatTime){return null}var i={};i.patterns=t;i.durationPattern=n;i.callback=r;i.time=this.lastBeatTime+(e-this.beat)*this.beatLength;this.queue.push(i);return i};Scheduler.prototype.remove=function(e){var t=this.queue.heap.indexOf(e);if(t!=-1){this.queue.heap.splice(t,1);this.queue=new PriorityQueue(this.queue.heap,function(e,t){return e.time<t.time})}};Scheduler.prototype.stop=function(e){this.remove(e)};Scheduler.prototype.tick=function(){PassThroughNode.prototype.tick.call(this);this.tickClock();while(!this.queue.isEmpty()&&this.queue.peek().time<=this.time){var e=this.queue.pop();this.processEvent(e)}};Scheduler.prototype.tickClock=function(){this.time+=1;this.seconds=this.time/this.audiolet.device.sampleRate;if(this.time>=this.lastBeatTime+this.beatLength){this.beat+=1;this.beatInBar+=1;if(this.beatInBar==this.beatsPerBar){this.bar+=1;this.beatInBar=0}this.lastBeatTime+=this.beatLength}};Scheduler.prototype.processEvent=function(e){var t=e.durationPattern;if(t){var n=[];var r=e.patterns;var i=r.length;for(var s=0;s<i;s++){var o=r[s];var u=o.next();if(u!=null){n.push(u)}else{return}}e.callback.apply(null,n);var a;if(t instanceof Pattern){a=t.next()}else{a=t}if(a){e.time+=a*this.beatLength;this.queue.push(e)}}else{e.callback()}};Scheduler.prototype.toString=function(){return"Scheduler"};var Int8Array,Uint8Array,Int16Array,Uint16Array;var Int32Array,Uint32Array,Float32Array,Float64Array;var types=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];var original,shim;for(var i=0;i<types.length;++i){if(types[i]){if(types[i].prototype.slice===undefined){original="subarray";shim="slice"}else if(types[i].prototype.subarray===undefined){original="slice";shim="subarray"}Object.defineProperty(types[i].prototype,shim,{value:types[i].prototype[original],enumerable:false})}}var Envelope=function(e,t,n,r,i,s){AudioletNode.call(this,e,1,1);this.gate=new AudioletParameter(this,0,t||1);this.levels=[];for(var o=0;o<n.length;o++){this.levels.push(new AudioletParameter(this,null,n[o]))}this.times=[];for(var o=0;o<r.length;o++){this.times.push(new AudioletParameter(this,null,r[o]))}this.releaseStage=i;this.onComplete=s;this.stage=null;this.time=null;this.changeTime=null;this.level=this.levels[0].getValue();this.delta=0;this.gateOn=false};extend(Envelope,AudioletNode);Envelope.prototype.generate=function(){var e=this.gate.getValue();var t=false;if(e&&!this.gateOn){this.gateOn=true;this.stage=0;this.time=0;this.delta=0;this.level=this.levels[0].getValue();if(this.stage!=this.releaseStage){t=true}}if(this.gateOn&&!e){this.gateOn=false;if(this.releaseStage!=null){this.stage=this.releaseStage;t=true}}if(this.changeTime){this.time+=1;if(this.time>=this.changeTime){this.stage+=1;if(this.stage!=this.releaseStage){t=true}else{this.changeTime=null;this.delta=0}}}if(t){if(this.stage!=this.times.length){this.delta=this.calculateDelta(this.stage,this.level);this.changeTime=this.calculateChangeTime(this.stage,this.time)}else{if(this.onComplete){this.onComplete()}this.stage=null;this.time=null;this.changeTime=null;this.delta=0}}this.level+=this.delta;this.outputs[0].samples[0]=this.level};Envelope.prototype.calculateDelta=function(e,t){var n=this.levels[e+1].getValue()-t;var r=this.times[e].getValue()*this.audiolet.device.sampleRate;return n/r};Envelope.prototype.calculateChangeTime=function(e,t){var n=this.times[e].getValue()*this.audiolet.device.sampleRate;return t+n};Envelope.prototype.toString=function(){return"Envelope"};var ADSREnvelope=function(e,t,n,r,i,s,o){var u=[0,1,i,0];var a=[n,r,s];Envelope.call(this,e,t,u,a,2,o);this.attack=this.times[0];this.decay=this.times[1];this.sustain=this.levels[2];this.release=this.levels[2]};extend(ADSREnvelope,Envelope);ADSREnvelope.prototype.toString=function(){return"ADSR Envelope"};var BiquadFilter=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.frequency=new AudioletParameter(this,1,t||22100);this.lastFrequency=null;this.xValues=[];this.yValues=[];this.b0=0;this.b1=0;this.b2=0;this.a0=0;this.a1=0;this.a2=0};extend(BiquadFilter,AudioletNode);BiquadFilter.prototype.calculateCoefficients=function(e){};BiquadFilter.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.xValues;var r=this.yValues;var i=this.frequency.getValue();if(i!=this.lastFrequency){this.calculateCoefficients(i);this.lastFrequency=i}var s=this.a0;var o=this.a1;var u=this.a2;var a=this.b0;var f=this.b1;var l=this.b2;var c=e.samples.length;for(var h=0;h<c;h++){if(h>=n.length){n.push([0,0]);r.push([0,0])}var p=n[h];var d=p[0];var v=p[1];var m=r[h];var g=m[0];var y=m[1];var b=e.samples[h];var w=a/s*b+f/s*d+l/s*v-o/s*g-u/s*y;t.samples[h]=w;p[0]=b;p[1]=d;m[0]=w;m[1]=g}};BiquadFilter.prototype.toString=function(){return"Biquad Filter"};var AllPassFilter=function(e,t){BiquadFilter.call(this,e,t)};extend(AllPassFilter,BiquadFilter);AllPassFilter.prototype.calculateCoefficients=function(e){var t=2*Math.PI*e/this.audiolet.device.sampleRate;var n=Math.cos(t);var r=Math.sin(t);var i=r/(2/Math.sqrt(2));this.b0=1-i;this.b1=-2*n;this.b2=1+i;this.a0=1+i;this.a1=-2*n;this.a2=1-i};AllPassFilter.prototype.toString=function(){return"All Pass Filter"};var Amplitude=function(e,t,n){AudioletNode.call(this,e,3,1);this.linkNumberOfOutputChannels(0,0);this.followers=[];this.attack=new AudioletParameter(this,1,t||.01);this.release=new AudioletParameter(this,2,n||.01)};extend(Amplitude,AudioletNode);Amplitude.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.followers;var r=n.length;var i=this.audiolet.device.sampleRate;var s=this.attack.getValue();s=Math.pow(.01,1/(s*i));var o=this.release.getValue();o=Math.pow(.01,1/(o*i));var u=e.samples.length;for(var a=0;a<u;a++){if(a>=r){n.push(0)}var f=n[a];var l=Math.abs(e.samples[a]);if(l>f){f=s*(f-l)+l}else{f=o*(f-l)+l}t.samples[a]=f;n[a]=f}};Amplitude.prototype.toString=function(){return"Amplitude"};var BadValueDetector=function(e,t){PassThroughNode.call(this,e,1,1);this.linkNumberOfOutputChannels(0,0);if(t){this.callback=t}};extend(BadValueDetector,PassThroughNode);BadValueDetector.prototype.callback=function(e,t){console.error(e+" detected at channel "+t)};BadValueDetector.prototype.generate=function(){var e=this.inputs[0];var t=e.samples.length;for(var n=0;n<t;n++){var r=e.samples[n];if(typeof r=="undefined"||r==null||isNaN(r)||r==Infinity||r==-Infinity){this.callback(r,n)}}};BadValueDetector.prototype.toString=function(){return"Bad Value Detector"};var BandPassFilter=function(e,t){BiquadFilter.call(this,e,t)};extend(BandPassFilter,BiquadFilter);BandPassFilter.prototype.calculateCoefficients=function(e){var t=2*Math.PI*e/this.audiolet.device.sampleRate;var n=Math.cos(t);var r=Math.sin(t);var i=r/(2/Math.sqrt(2));this.b0=i;this.b1=0;this.b2=-i;this.a0=1+i;this.a1=-2*n;this.a2=1-i};BandPassFilter.prototype.toString=function(){return"Band Pass Filter"};var BandRejectFilter=function(e,t){BiquadFilter.call(this,e,t)};extend(BandRejectFilter,BiquadFilter);BandRejectFilter.prototype.calculateCoefficients=function(e){var t=2*Math.PI*e/this.audiolet.device.sampleRate;var n=Math.cos(t);var r=Math.sin(t);var i=r/(2/Math.sqrt(2));this.b0=1;this.b1=-2*n;this.b2=1;this.a0=1+i;this.a1=-2*n;this.a2=1-i};BandRejectFilter.prototype.toString=function(){return"Band Reject Filter"};var BitCrusher=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.bits=new AudioletParameter(this,1,t)};extend(BitCrusher,AudioletNode);BitCrusher.prototype.generate=function(){var e=this.inputs[0];var t=Math.pow(2,this.bits.getValue())-1;var n=e.samples.length;for(var r=0;r<n;r++){this.outputs[0].samples[r]=Math.floor(e.samples[r]*t)/t}};BitCrusher.prototype.toString=function(){return"BitCrusher"};var BufferPlayer=function(e,t,n,r,i,s){AudioletNode.call(this,e,3,1);this.buffer=t;this.setNumberOfOutputChannels(0,this.buffer.numberOfChannels);this.position=r||0;this.playbackRate=new AudioletParameter(this,0,n||1);this.restartTrigger=new AudioletParameter(this,1,0);this.startPosition=new AudioletParameter(this,2,r||0);this.loop=new AudioletParameter(this,3,i||0);this.onComplete=s;this.restartTriggerOn=false;this.playing=true};extend(BufferPlayer,AudioletNode);BufferPlayer.prototype.generate=function(){var e=this.outputs[0];var t=e.samples.length;if(this.buffer.length==0||!this.playing){for(var n=0;n<t;n++){e.samples[n]=0}return}var r=this.playbackRate.getValue();var i=this.restartTrigger.getValue();var s=this.startPosition.getValue();var o=this.loop.getValue();if(i>0&&!this.restartTriggerOn){this.position=s;this.restartTriggerOn=true;this.playing=true}if(i<=0&&this.restartTriggerOn){this.restartTriggerOn=false}var t=this.buffer.channels.length;for(var n=0;n<t;n++){var u=this.buffer.getChannelData(n);e.samples[n]=u[Math.floor(this.position)]}this.position+=r;if(this.position>=this.buffer.length){if(o){this.position%=this.buffer.length}else{this.playing=false;if(this.onComplete){this.onComplete()}}}};BufferPlayer.prototype.toString=function(){return"Buffer player"};var CombFilter=function(e,t,n,r){AudioletNode.call(this,e,3,1);this.linkNumberOfOutputChannels(0,0);this.maximumDelayTime=t;this.delayTime=new AudioletParameter(this,1,n||1);this.decayTime=new AudioletParameter(this,2,r);this.buffers=[];this.readWriteIndex=0};extend(CombFilter,AudioletNode);CombFilter.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.audiolet.device.sampleRate;var r=this.delayTime.getValue()*n;var i=this.decayTime.getValue()*n;var s=Math.exp(-3*r/i);var o=e.samples.length;for(var u=0;u<o;u++){if(u>=this.buffers.length){var a=this.maximumDelayTime*n;this.buffers.push(new Float32Array(a))}var f=this.buffers[u];var l=f[this.readWriteIndex];t.samples[u]=l;f[this.readWriteIndex]=e.samples[u]+s*l}this.readWriteIndex+=1;if(this.readWriteIndex>=r){this.readWriteIndex=0}};CombFilter.prototype.toString=function(){return"Comb Filter"};var Sine=function(e,t){AudioletNode.call(this,e,1,1);this.frequency=new AudioletParameter(this,0,t||440);this.phase=0};extend(Sine,AudioletNode);Sine.prototype.generate=function(){var e=this.outputs[0];var t=this.frequency.getValue();var n=this.audiolet.device.sampleRate;e.samples[0]=Math.sin(this.phase);this.phase+=2*Math.PI*t/n;if(this.phase>2*Math.PI){this.phase%=2*Math.PI}};Sine.prototype.toString=function(){return"Sine"};var CrossFade=function(e,t){AudioletNode.call(this,e,3,1);this.linkNumberOfOutputChannels(0,0);this.position=new AudioletParameter(this,2,t||.5)};extend(CrossFade,AudioletNode);CrossFade.prototype.generate=function(){var e=this.inputs[0];var t=this.inputs[1];var n=this.outputs[0];var r=this.position.getValue();var i=r*Math.PI/2;var s=Math.cos(i);var o=Math.sin(i);var u=n.samples.length;for(var a=0;a<u;a++){var f=e.samples[a]||0;var l=t.samples[a]||0;n.samples[a]=f*s+l*o}};CrossFade.prototype.toString=function(){return"Cross Fader"};var DampedCombFilter=function(e,t,n,r,i){AudioletNode.call(this,e,4,1);this.linkNumberOfOutputChannels(0,0);this.maximumDelayTime=t;this.delayTime=new AudioletParameter(this,1,n||1);this.decayTime=new AudioletParameter(this,2,r);this.damping=new AudioletParameter(this,3,i);var s=t*this.audiolet.device.sampleRate;this.buffers=[];this.readWriteIndex=0;this.filterStores=[]};extend(DampedCombFilter,AudioletNode);DampedCombFilter.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.audiolet.device.sampleRate;var r=this.delayTime.getValue()*n;var i=this.decayTime.getValue()*n;var s=this.damping.getValue();var o=Math.exp(-3*r/i);var u=e.samples.length;for(var a=0;a<u;a++){if(a>=this.buffers.length){var f=this.maximumDelayTime*n;this.buffers.push(new Float32Array(f))}if(a>=this.filterStores.length){this.filterStores.push(0)}var l=this.buffers[a];var c=this.filterStores[a];var h=l[this.readWriteIndex];c=h*(1-s)+c*s;t.samples[a]=h;l[this.readWriteIndex]=e.samples[a]+o*c;this.filterStores[a]=c}this.readWriteIndex+=1;if(this.readWriteIndex>=r){this.readWriteIndex=0}};DampedCombFilter.prototype.toString=function(){return"Damped Comb Filter"};var DCFilter=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.coefficient=new AudioletParameter(this,1,t||.995);this.xValues=[];this.yValues=[]};extend(DCFilter,AudioletNode);DCFilter.prototype.generate=function(){var e=this.coefficient.getValue();var t=this.inputs[0];var n=t.samples.length;for(var r=0;r<n;r++){if(r>=this.xValues.length){this.xValues.push(0)}if(r>=this.yValues.length){this.yValues.push(0)}var i=t.samples[r];var s=i-this.xValues[r]+e*this.yValues[r];this.outputs[0].samples[r]=s;this.xValues[r]=i;this.yValues[r]=s}};DCFilter.prototype.toString=function(){return"DC Filter"};var Delay=function(e,t,n){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.maximumDelayTime=t;this.delayTime=new AudioletParameter(this,1,n||1);var r=t*this.audiolet.device.sampleRate;this.buffers=[];this.readWriteIndex=0};extend(Delay,AudioletNode);Delay.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.audiolet.device.sampleRate;var r=this.delayTime.getValue()*n;var i=e.samples.length;for(var s=0;s<i;s++){if(s>=this.buffers.length){var o=this.maximumDelayTime*n;this.buffers.push(new Float32Array(o))}var u=this.buffers[s];t.samples[s]=u[this.readWriteIndex];u[this.readWriteIndex]=e.samples[s]}this.readWriteIndex+=1;if(this.readWriteIndex>=r){this.readWriteIndex=0}};Delay.prototype.toString=function(){return"Delay"};var DiscontinuityDetector=function(e,t,n){AudioletNode.call(this,e,1,1);this.linkNumberOfOutputChannels(0,0);this.threshold=t||.2;if(n){this.callback=n}this.lastValues=[]};extend(DiscontinuityDetector,AudioletNode);DiscontinuityDetector.prototype.callback=function(e,t){console.error("Discontinuity of "+e+" detected on channel "+t)};DiscontinuityDetector.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=e.samples.length;for(var r=0;r<n;r++){if(r>=this.lastValues.length){this.lastValues.push(0)}var i=e.samples[r];var s=Math.abs(this.lastValues[r]-i);if(s>this.threshold){this.callback(s,r)}this.lastValues[r]=i}};DiscontinuityDetector.prototype.toString=function(){return"Discontinuity Detector"};var FeedbackDelay=function(e,t,n,r,i){AudioletNode.call(this,e,4,1);this.linkNumberOfOutputChannels(0,0);this.maximumDelayTime=t;this.delayTime=new AudioletParameter(this,1,n||1);this.feedback=new AudioletParameter(this,2,r||.5);this.mix=new AudioletParameter(this,3,i||1);var s=t*this.audiolet.device.sampleRate;this.buffers=[];this.readWriteIndex=0};extend(FeedbackDelay,AudioletNode);FeedbackDelay.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.audiolet.output.device.sampleRate;var r=this.delayTime.getValue()*n;var i=this.feedback.getValue();var s=this.mix.getValue();var o=e.samples.length;var u=this.buffers.length;for(var a=0;a<o;a++){if(a>=u){var f=this.maximumDelayTime*n;this.buffers.push(new Float32Array(f))}var l=this.buffers[a];var c=e.samples[a];var h=l[this.readWriteIndex];t.samples[a]=s*h+(1-s)*c;l[this.readWriteIndex]=c+i*h}this.readWriteIndex+=1;if(this.readWriteIndex>=r){this.readWriteIndex=0}};FeedbackDelay.prototype.toString=function(){return"Feedback Delay"};var FFT=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.bufferSize=t;this.readWriteIndex=0;this.buffer=new Float32Array(this.bufferSize);this.realBuffer=new Float32Array(this.bufferSize);this.imaginaryBuffer=new Float32Array(this.bufferSize);this.reverseTable=new Uint32Array(this.bufferSize);this.calculateReverseTable()};extend(FFT,AudioletNode);FFT.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];if(e.samples.length==0){return}this.buffer[this.readWriteIndex]=e.samples[0];t.samples[0]=[this.realBuffer[this.readWriteIndex],this.imaginaryBuffer[this.readWriteIndex]];this.readWriteIndex+=1;if(this.readWriteIndex>=this.bufferSize){this.transform();this.readWriteIndex=0}};FFT.prototype.calculateReverseTable=function(){var e=1;var t=this.bufferSize>>1;while(e<this.bufferSize){for(var n=0;n<e;n++){this.reverseTable[n+e]=this.reverseTable[n]+t}e=e<<1;t=t>>1}};FFT.prototype.transform=function(){for(var e=0;e<this.bufferSize;e++){this.realBuffer[e]=this.buffer[this.reverseTable[e]];this.imaginaryBuffer[e]=0}var t=1;while(t<this.bufferSize){var n=Math.cos(-Math.PI/t);var r=Math.sin(-Math.PI/t);var i=1;var s=0;for(var o=0;o<t;o++){var e=o;while(e<this.bufferSize){var u=e+t;var a=i*this.realBuffer[u]-s*this.imaginaryBuffer[u];var f=i*this.imaginaryBuffer[u]+s*this.realBuffer[u];this.realBuffer[u]=this.realBuffer[e]-a;this.imaginaryBuffer[u]=this.imaginaryBuffer[e]-f;this.realBuffer[e]+=a;this.imaginaryBuffer[e]+=f;e+=t<<1}var l=i;i=l*n-s*r;s=l*r+s*n}t=t<<1}};FFT.prototype.toString=function(){return"FFT"};var Multiply=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.value=new AudioletParameter(this,1,t||1)};extend(Multiply,AudioletNode);Multiply.prototype.generate=function(){var e=this.value.getValue();var t=this.inputs[0];var n=t.samples.length;for(var r=0;r<n;r++){this.outputs[0].samples[r]=t.samples[r]*e}};Multiply.prototype.toString=function(){return"Multiply"};var Gain=function(e,t){Multiply.call(this,e,t);this.gain=this.value};extend(Gain,Multiply);Gain.prototype.toString=function(){return"Gain"};var HighPassFilter=function(e,t){BiquadFilter.call(this,e,t)};extend(HighPassFilter,BiquadFilter);HighPassFilter.prototype.calculateCoefficients=function(e){var t=2*Math.PI*e/this.audiolet.device.sampleRate;var n=Math.cos(t);var r=Math.sin(t);var i=r/(2/Math.sqrt(2));this.b0=(1+n)/2;this.b1=-(1+n);this.b2=this.b0;this.a0=1+i;this.a1=-2*n;this.a2=1-i};HighPassFilter.prototype.toString=function(){return"High Pass Filter"};var IFFT=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.bufferSize=t;this.readWriteIndex=0;this.buffer=new Float32Array(this.bufferSize);this.realBuffer=new Float32Array(this.bufferSize);this.imaginaryBuffer=new Float32Array(this.bufferSize);this.reverseTable=new Uint32Array(this.bufferSize);this.calculateReverseTable();this.reverseReal=new Float32Array(this.bufferSize);this.reverseImaginary=new Float32Array(this.bufferSize)};extend(IFFT,AudioletNode);IFFT.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];if(!e.samples.length){return}var n=e.samples[0];this.realBuffer[this.readWriteIndex]=n[0];this.imaginaryBuffer[this.readWriteIndex]=n[1];t.samples[0]=this.buffer[this.readWriteIndex];this.readWriteIndex+=1;if(this.readWriteIndex>=this.bufferSize){this.transform();this.readWriteIndex=0}};IFFT.prototype.calculateReverseTable=function(){var e=1;var t=this.bufferSize>>1;while(e<this.bufferSize){for(var n=0;n<e;n++){this.reverseTable[n+e]=this.reverseTable[n]+t}e=e<<1;t=t>>1}};IFFT.prototype.transform=function(){var e=1;for(var t=0;t<this.bufferSize;t++){this.imaginaryBuffer[t]*=-1}for(var t=0;t<this.bufferSize;t++){this.reverseReal[t]=this.realBuffer[this.reverseTable[t]];this.reverseImaginary[t]=this.imaginaryBuffer[this.reverseTable[t]]}this.realBuffer.set(this.reverseReal);this.imaginaryBuffer.set(this.reverseImaginary);while(e<this.bufferSize){var n=Math.cos(-Math.PI/e);var r=Math.sin(-Math.PI/e);var i=1;var s=0;for(var o=0;o<e;o++){t=o;while(t<this.bufferSize){var u=t+e;var a=i*this.realBuffer[u]-s*this.imaginaryBuffer[u];var f=i*this.imaginaryBuffer[u]+s*this.realBuffer[u];this.realBuffer[u]=this.realBuffer[t]-a;this.imaginaryBuffer[u]=this.imaginaryBuffer[t]-f;this.realBuffer[t]+=a;this.imaginaryBuffer[t]+=f;t+=e<<1}var l=i;i=l*n-s*r;s=l*r+s*n}e=e<<1}for(t=0;t<this.bufferSize;t++){this.buffer[t]=this.realBuffer[t]/this.bufferSize}};IFFT.prototype.toString=function(){return"IFFT"};var Lag=function(e,t,n){AudioletNode.call(this,e,2,1);this.value=new AudioletParameter(this,0,t||0);this.lag=new AudioletParameter(this,1,n||1);this.lastValue=0;this.log001=Math.log(.001)};extend(Lag,AudioletNode);Lag.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.audiolet.device.sampleRate;var r=this.value.getValue();var i=this.lag.getValue();var s=Math.exp(this.log001/(i*n));var o=(1-s)*r+s*this.lastValue;t.samples[0]=o;this.lastValue=o};Lag.prototype.toString=function(){return"Lag"};var Limiter=function(e,t,n,r){AudioletNode.call(this,e,4,1);this.linkNumberOfOutputChannels(0,0);this.threshold=new AudioletParameter(this,1,t||.95);this.attack=new AudioletParameter(this,2,n||.01);this.release=new AudioletParameter(this,2,r||.4);this.followers=[]};extend(Limiter,AudioletNode);Limiter.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.audiolet.device.sampleRate;var r=Math.pow(.01,1/(this.attack.getValue()*n));var i=Math.pow(.01,1/(this.release.getValue()*n));var s=this.threshold.getValue();var o=e.samples.length;for(var u=0;u<o;u++){if(u>=this.followers.length){this.followers.push(0)}var a=this.followers[u];var f=e.samples[u];var l=Math.abs(f);if(l>a){a=r*(a-l)+l}else{a=i*(a-l)+l}var c=a-s;if(c>0){t.samples[u]=f/(1+c)}else{t.samples[u]=f}this.followers[u]=a}};Limiter.prototype.toString=function(){return"Limiter"};var LinearCrossFade=function(e,t){AudioletNode.call(this,e,3,1);this.linkNumberOfOutputChannels(0,0);this.position=new AudioletParameter(this,2,t||.5)};extend(LinearCrossFade,AudioletNode);LinearCrossFade.prototype.generate=function(){var e=this.inputs[0];var t=this.inputs[1];var n=this.outputs[0];var r=this.position.getValue();var i=1-r;var s=r;var o=n.samples.length;for(var u=0;u<o;u++){var a=e.samples[u]||0;var f=t.samples[u]||0;n.samples[u]=a*i+f*s}};LinearCrossFade.prototype.toString=function(){return"Linear Cross Fader"};var LowPassFilter=function(e,t){BiquadFilter.call(this,e,t)};extend(LowPassFilter,BiquadFilter);LowPassFilter.prototype.calculateCoefficients=function(e){var t=2*Math.PI*e/this.audiolet.device.sampleRate;var n=Math.cos(t);var r=Math.sin(t);var i=r/(2/Math.sqrt(2));this.b0=(1-n)/2;this.b1=1-n;this.b2=this.b0;this.a0=1+i;this.a1=-2*n;this.a2=1-i};LowPassFilter.prototype.toString=function(){return"Low Pass Filter"};var Pan=function(e,t){AudioletNode.call(this,e,2,1);this.setNumberOfOutputChannels(0,2);if(t==null){var t=.5}this.pan=new AudioletParameter(this,1,t)};extend(Pan,AudioletNode);Pan.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.pan.getValue();var r=e.samples[0]||0;var i=n*Math.PI/2;t.samples[0]=r*Math.cos(i);t.samples[1]=r*Math.sin(i)};Pan.prototype.toString=function(){return"Stereo Panner"};var PercussiveEnvelope=function(e,t,n,r,i){var s=[0,1,0];var o=[n,r];Envelope.call(this,e,t,s,o,null,i);this.attack=this.times[0];this.release=this.times[1]};extend(PercussiveEnvelope,Envelope);PercussiveEnvelope.prototype.toString=function(){return"Percussive Envelope"};var Pulse=function(e,t,n){AudioletNode.call(this,e,2,1);this.frequency=new AudioletParameter(this,0,t||440);this.pulseWidth=new AudioletParameter(this,1,n||.5);this.phase=0};extend(Pulse,AudioletNode);Pulse.prototype.generate=function(){var e=this.pulseWidth.getValue();this.outputs[0].samples[0]=this.phase<e?1:-1;var t=this.frequency.getValue();var n=this.audiolet.device.sampleRate;this.phase+=t/n;if(this.phase>1){this.phase%=1}};Pulse.prototype.toString=function(){return"Pulse"};var Reverb=function(e,t,n,r){AudioletNode.call(this,e,4,1);this.initialMix=.33;this.fixedGain=.015;this.initialDamping=.5;this.scaleDamping=.4;this.initialRoomSize=.5;this.scaleRoom=.28;this.offsetRoom=.7;this.combTuning=[1116,1188,1277,1356,1422,1491,1557,1617];this.allPassTuning=[556,441,341,225];var t=t||this.initialMix;this.mix=new AudioletParameter(this,1,t);var n=n||this.initialRoomSize;this.roomSize=new AudioletParameter(this,2,n);var r=r||this.initialDamping;this.damping=new AudioletParameter(this,3,r);this.combBuffers=[];this.combIndices=[];this.filterStores=[];var i=this.combTuning.length;for(var s=0;s<i;s++){this.combBuffers.push(new Float32Array(this.combTuning[s]));this.combIndices.push(0);this.filterStores.push(0)}this.allPassBuffers=[];this.allPassIndices=[];var o=this.allPassTuning.length;for(var s=0;s<o;s++){this.allPassBuffers.push(new Float32Array(this.allPassTuning[s]));this.allPassIndices.push(0)}};extend(Reverb,AudioletNode);Reverb.prototype.generate=function(){var e=this.mix.getValue();var t=this.roomSize.getValue();var n=this.damping.getValue();var r=this.combTuning.length;var i=this.allPassTuning.length;var s=this.inputs[0].samples[0]||0;var o=s;s*=this.fixedGain;var u=s;var n=n*this.scaleDamping;var a=t*this.scaleRoom+this.offsetRoom;for(var f=0;f<r;f++){var l=this.combIndices[f];var c=this.combBuffers[f];var h=this.filterStores[f];var p=c[l];h=p*(1-n)+h*n;s+=p;c[l]=u+a*h;l+=1;if(l>=c.length){l=0}this.combIndices[f]=l;this.filterStores[f]=h}for(var f=0;f<i;f++){var d=this.allPassBuffers[f];var v=this.allPassIndices[f];var m=s;var g=d[v];s=-s+g;d[v]=m+g*.5;v+=1;if(v>=d.length){v=0}this.allPassIndices[f]=v}this.outputs[0].samples[0]=e*s+(1-e)*o};Reverb.prototype.toString=function(){return"Reverb"};var Saw=function(e,t){AudioletNode.call(this,e,1,1);this.frequency=new AudioletParameter(this,0,t||440);this.phase=0};extend(Saw,AudioletNode);Saw.prototype.generate=function(){var e=this.outputs[0];var t=this.frequency.getValue();var n=this.audiolet.device.sampleRate;e.samples[0]=((this.phase/2+.25)%.5-.25)*4;this.phase+=t/n;if(this.phase>1){this.phase%=1}};Saw.prototype.toString=function(){return"Saw"};var SoftClip=function(e){AudioletNode.call(this,e,1,1);this.linkNumberOfOutputChannels(0,0)};extend(SoftClip,AudioletNode);SoftClip.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=e.samples.length;for(var r=0;r<n;r++){var i=e.samples[r];if(i>.5||i<-.5){t.samples[r]=(Math.abs(i)-.25)/i}else{t.samples[r]=i}}};SoftClip.prototype.toString=function(){return"SoftClip"};var Square=function(e,t){AudioletNode.call(this,e,1,1);this.frequency=new AudioletParameter(this,0,t||440);this.phase=0};extend(Square,AudioletNode);Square.prototype.generate=function(){var e=this.outputs[0];var t=this.frequency.getValue();var n=this.audiolet.device.sampleRate;e.samples[0]=this.phase>.5?1:-1;this.phase+=t/n;if(this.phase>1){this.phase%=1}};Square.prototype.toString=function(){return"Square"};var Triangle=function(e,t){AudioletNode.call(this,e,1,1);this.frequency=new AudioletParameter(this,0,t||440);this.phase=0};extend(Triangle,AudioletNode);Triangle.prototype.generate=function(){var e=this.outputs[0];var t=this.frequency.getValue();var n=this.audiolet.device.sampleRate;e.samples[0]=1-4*Math.abs((this.phase+.25)%1-.5);this.phase+=t/n;if(this.phase>1){this.phase%=1}};Triangle.prototype.toString=function(){return"Triangle"};var TriggerControl=function(e,t){AudioletNode.call(this,e,0,1);this.trigger=new AudioletParameter(this,null,t||0)};extend(TriggerControl,AudioletNode);TriggerControl.prototype.generate=function(){if(this.trigger.getValue()>0){this.outputs[0].samples[0]=1;this.trigger.setValue(0)}else{this.outputs[0].samples[0]=0}};TriggerControl.prototype.toString=function(){return"Trigger Control"};var UpMixer=function(e,t){AudioletNode.call(this,e,1,1);this.outputs[0].numberOfChannels=t};extend(UpMixer,AudioletNode);UpMixer.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=e.samples.length;var r=t.samples.length;if(n==r){t.samples=e.samples}else{for(var i=0;i<r;i++){t.samples[i]=e.samples[i%n]}}};UpMixer.prototype.toString=function(){return"UpMixer"};var WebKitBufferPlayer=function(e,t){AudioletNode.call(this,e,0,1);this.onComplete=t;this.isWebKit=this.audiolet.device.sink instanceof Sink.sinks.webkit;this.ready=false;this.setNumberOfOutputChannels(0,0);if(!this.isWebKit){return}this.context=this.audiolet.device.sink._context;this.jsNode=null;this.source=null;this.ready=false;this.loaded=false;this.buffers=[];this.readPosition=0;this.endTime=null};extend(WebKitBufferPlayer,AudioletNode);WebKitBufferPlayer.prototype.load=function(e,t,n){if(!this.isWebKit){return}this.stop();this.xhr=new XMLHttpRequest;this.xhr.open("GET",e,true);this.xhr.responseType="arraybuffer";this.xhr.onload=this.onLoad.bind(this,t,n);this.xhr.onerror=n;this.xhr.send()};WebKitBufferPlayer.prototype.stop=function(){this.ready=false;this.loaded=false;this.buffers=[];this.readPosition=0;this.endTime=null;this.setNumberOfOutputChannels(0);this.disconnectWebKitNodes()};WebKitBufferPlayer.prototype.disconnectWebKitNodes=function(){if(this.source&&this.jsNode){this.source.disconnect(this.jsNode);this.jsNode.disconnect(this.context.destination);this.source=null;this.jsNode=null}};WebKitBufferPlayer.prototype.onLoad=function(e,t){this.context.decodeAudioData(this.xhr.response,function(t){this.onDecode(t);e()}.bind(this),t)};WebKitBufferPlayer.prototype.onDecode=function(e){this.fileBuffer=e;this.source=this.context.createBufferSource();this.source.buffer=this.fileBuffer;var t=this.fileBuffer.numberOfChannels;this.setNumberOfOutputChannels(0,t);this.jsNode=this.context.createJavaScriptNode(4096,t,0);this.jsNode.onaudioprocess=this.onData.bind(this);this.source.connect(this.jsNode);this.jsNode.connect(this.context.destination);this.source.noteOn(0);this.endTime=this.context.currentTime+this.fileBuffer.duration;this.loaded=true};WebKitBufferPlayer.prototype.onData=function(e){if(this.loaded){this.ready=true}var t=e.inputBuffer.numberOfChannels;for(var n=0;n<t;n++){this.buffers[n]=e.inputBuffer.getChannelData(n);this.readPosition=0}};WebKitBufferPlayer.prototype.generate=function(){if(!this.ready){return}var e=this.outputs[0];var t=e.samples.length;for(var n=0;n<t;n++){e.samples[n]=this.buffers[n][this.readPosition]}this.readPosition+=1;if(this.context.currentTime>this.endTime){this.stop();this.onComplete()}};var WhiteNoise=function(e){AudioletNode.call(this,e,0,1)};extend(WhiteNoise,AudioletNode);WhiteNoise.prototype.generate=function(){this.outputs[0].samples[0]=Math.random()*2-1};WhiteNoise.prototype.toString=function(){return"White Noise"};var Add=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.value=new AudioletParameter(this,1,t||0)};extend(Add,AudioletNode);Add.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.value.getValue();var r=e.samples.length;for(var i=0;i<r;i++){t.samples[i]=e.samples[i]+n}};Add.prototype.toString=function(){return"Add"};var Divide=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.value=new AudioletParameter(this,1,t||1)};extend(Divide,AudioletNode);Divide.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.value.getValue();var r=e.samples.length;for(var i=0;i<r;i++){t.samples[i]=e.samples[i]/n}};Divide.prototype.toString=function(){return"Divide"};var Modulo=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.value=new AudioletParameter(this,1,t||1)};extend(Modulo,AudioletNode);Modulo.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.value.getValue();var r=e.samples.length;for(var i=0;i<r;i++){t.samples[i]=e.samples[i]%n}};Modulo.prototype.toString=function(){return"Modulo"};var MulAdd=function(e,t,n){AudioletNode.call(this,e,3,1);this.linkNumberOfOutputChannels(0,0);this.mul=new AudioletParameter(this,1,t||1);this.add=new AudioletParameter(this,2,n||0)};extend(MulAdd,AudioletNode);MulAdd.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.mul.getValue();var r=this.add.getValue();var i=e.samples.length;for(var s=0;s<i;s++){t.samples[s]=e.samples[s]*n+r}};MulAdd.prototype.toString=function(){return"Multiplier/Adder"};var Reciprocal=function(e){AudioletNode.call(this,e,1,1);this.linkNumberOfOutputChannels(0,0)};extend(Reciprocal,AudioletNode);Reciprocal.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=e.samples.length;for(var r=0;r<n;r++){t.samples[r]=1/e.samples[r]}};Reciprocal.prototype.toString=function(){return"Reciprocal"};var Subtract=function(e,t){AudioletNode.call(this,e,2,1);this.linkNumberOfOutputChannels(0,0);this.value=new AudioletParameter(this,1,t||0)};extend(Subtract,AudioletNode);Subtract.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=this.value.getValue();var r=e.samples.length;for(var i=0;i<r;i++){t.samples[i]=e.samples[i]-n}};Subtract.prototype.toString=function(){return"Subtract"};var Tanh=function(e){AudioletNode.call(this,e,1,1);this.linkNumberOfOutputChannels(0,0)};extend(Tanh,AudioletNode);Tanh.prototype.generate=function(){var e=this.inputs[0];var t=this.outputs[0];var n=e.samples.length;for(var r=0;r<n;r++){var i=e.samples[r];t.samples[r]=(Math.exp(i)-Math.exp(-i))/(Math.exp(i)+Math.exp(-i))}};Tanh.prototype.toString=function(){return"Tanh"};var Pattern=function(){};Pattern.prototype.next=function(){return null};Pattern.prototype.valueOf=function(e){if(e instanceof Pattern){return e.next()}else{return e}};Pattern.prototype.reset=function(){};var PArithmetic=function(e,t,n){Pattern.call(this);this.start=e;this.value=e;this.step=t;this.repeats=n;this.position=0};extend(PArithmetic,Pattern);PArithmetic.prototype.next=function(){var e;if(this.position==0){e=this.value;this.position+=1}else if(this.position<this.repeats){var t=this.valueOf(this.step);if(t!=null){this.value+=t;e=this.value;this.position+=1}else{e=null}}else{e=null}return e};PArithmetic.prototype.reset=function(){this.value=this.start;this.position=0;if(this.step instanceof Pattern){this.step.reset()}};var Pseries=PArithmetic;var PChoose=function(e,t){Pattern.call(this);this.list=e;this.repeats=t||1;this.position=0};extend(PChoose,Pattern);PChoose.prototype.next=function(){var e;if(this.position<this.repeats){var t=Math.floor(Math.random()*this.list.length);var n=this.list[t];var r=this.valueOf(n);if(r!=null){if(!(n instanceof Pattern)){this.position+=1}e=r}else{if(n instanceof Pattern){n.reset()}this.position+=1;e=this.next()}}else{e=null}return e};PChoose.prototype.reset=function(){this.position=0;for(var e=0;e<this.list.length;e++){var t=this.list[e];if(t instanceof Pattern){t.reset()}}};var Prand=PChoose;var PGeometric=function(e,t,n){Pattern.call(this);this.start=e;this.value=e;this.step=t;this.repeats=n;this.position=0};extend(PGeometric,Pattern);PGeometric.prototype.next=function(){var e;if(this.position==0){e=this.value;this.position+=1}else if(this.position<this.repeats){var t=this.valueOf(this.step);if(t!=null){this.value*=t;e=this.value;this.position+=1}else{e=null}}else{e=null}return e};PGeometric.prototype.reset=function(){this.value=this.start;this.position=0;if(this.step instanceof Pattern){this.step.reset()}};var Pgeom=PGeometric;var PProxy=function(e){Pattern.call(this);if(e){this.pattern=e}};extend(PProxy,Pattern);PProxy.prototype.next=function(){var e;if(this.pattern){var e=this.pattern.next()}else{e=null}return e};var Pp=PProxy;var PRandom=function(e,t,n){Pattern.call(this);this.low=e;this.high=t;this.repeats=n;this.position=0};extend(PRandom,Pattern);PRandom.prototype.next=function(){var e;if(this.position<this.repeats){var t=this.valueOf(this.low);var n=this.valueOf(this.high);if(t!=null&&n!=null){e=t+Math.random()*(n-t);this.position+=1}else{e=null}}else{e=null}return e};PRandom.prototype.reset=function(){this.position=0};var Pwhite=PRandom;var PSequence=function(e,t,n){Pattern.call(this);this.list=e;this.repeats=t||1;this.position=0;this.offset=n||0};extend(PSequence,Pattern);PSequence.prototype.next=function(){var e;if(this.position<this.repeats*this.list.length){var t=(this.position+this.offset)%this.list.length;var n=this.list[t];var r=this.valueOf(n);if(r!=null){if(!(n instanceof Pattern)){this.position+=1}e=r}else{if(n instanceof Pattern){n.reset()}this.position+=1;e=this.next()}}else{e=null}return e};PSequence.prototype.reset=function(){this.position=0;for(var e=0;e<this.list.length;e++){var t=this.list[e];if(t instanceof Pattern){t.reset()}}};var Pseq=PSequence;var PSeries=function(e,t,n){Pattern.call(this);this.list=e;this.repeats=t||1;this.position=0;this.offset=n||0};extend(PSeries,Pattern);PSeries.prototype.next=function(){var e;if(this.position<this.repeats){var t=(this.position+this.offset)%this.list.length;var n=this.list[t];var r=this.valueOf(n);if(r!=null){if(!(n instanceof Pattern)){this.position+=1}e=r}else{if(n instanceof Pattern){n.reset()}this.position+=1;e=this.next()}}else{e=null}return e};PSeries.prototype.reset=function(){this.position=0;for(var e=0;e<this.list.length;e++){var t=this.list[e];if(t instanceof Pattern){t.reset()}}};var Pser=PSeries;var PShuffle=function(e,t){Pattern.call(this);this.list=[];while(e.length){var n=Math.floor(Math.random()*e.length);var r=e.splice(n,1);this.list.push(r)}this.repeats=t;this.position=0};extend(PShuffle,Pattern);PShuffle.prototype.next=function(){var e;if(this.position<this.repeats*this.list.length){var t=(this.position+this.offset)%this.list.length;var n=this.list[t];var r=this.valueOf(n);if(r!=null){if(!(n instanceof Pattern)){this.position+=1}e=r}else{if(n instanceof Pattern){n.reset()}this.position+=1;e=this.next()}}else{e=null}return e};var Pshuffle=PShuffle;var Scale=function(e,t){this.degrees=e;this.tuning=t||new EqualTemperamentTuning(12)};Scale.prototype.getFrequency=function(e,t,n){var r=t;n+=Math.floor(e/this.degrees.length);e%=this.degrees.length;r*=Math.pow(this.tuning.octaveRatio,n);r*=this.tuning.ratios[this.degrees[e]];return r};var MajorScale=function(){Scale.call(this,[0,2,4,5,7,9,11])};extend(MajorScale,Scale);var MinorScale=function(){Scale.call(this,[0,2,3,5,7,8,10])};extend(MinorScale,Scale);var Tuning=function(e,t){this.semitones=e;this.octaveRatio=t||2;this.ratios=[];var n=this.semitones.length;for(var r=0;r<n;r++){this.ratios.push(Math.pow(2,this.semitones[r]/n))}};var EqualTemperamentTuning=function(e){var t=[];for(var n=0;n<e;n++){t.push(n)}Tuning.call(this,t,2)};extend(EqualTemperamentTuning,Tuning);var Sink=this.Sink=function(e){function t(e,n,r,i){var s=t.sinks.list,o;for(o=0;o<s.length;o++){if(s[o].enabled){try{return new s[o](e,n,r,i)}catch(u){}}}throw t.Error(2)}function n(){}function r(e,n,i,s,o){i=i||n.prototype;n.prototype=new t.SinkClass;n.prototype.type=e;n.enabled=!s;var u;for(u in i){if(i.hasOwnProperty(u)){n.prototype[u]=i[u]}}r[e]=n;r.list[o?"unshift":"push"](n)}t.SinkClass=n;n.prototype=t.prototype={sampleRate:44100,channelCount:2,bufferSize:4096,writePosition:0,previousHit:0,ringOffset:0,channelMode:"interleaved",isReady:false,start:function(e,n,r,i){this.channelCount=isNaN(n)||n===null?this.channelCount:n;this.bufferSize=isNaN(r)||r===null?this.bufferSize:r;this.sampleRate=isNaN(i)||i===null?this.sampleRate:i;this.readFn=e;this.activeRecordings=[];this.previousHit=+(new Date);t.EventEmitter.call(this);t.emit("init",[this].concat([].slice.call(arguments)))},process:function(e,n){this.emit("preprocess",arguments);if(this.ringBuffer){(this.channelMode==="interleaved"?this.ringSpin:this.ringSpinInterleaved).apply(this,arguments)}if(this.channelMode==="interleaved"){this.emit("audioprocess",arguments);if(this.readFn){this.readFn.apply(this,arguments)}}else{var r=t.deinterleave(e,this.channelCount),i=[r].concat([].slice.call(arguments,1));this.emit("audioprocess",i);if(this.readFn){this.readFn.apply(this,i)}t.interleave(r,this.channelCount,e)}this.emit("postprocess",arguments);this.previousHit=+(new Date);this.writePosition+=e.length/n},getPlaybackTime:function(){return this.writePosition-this.bufferSize},ready:function(){if(this.isReady)return;this.isReady=true;this.emit("ready",[])}};t.sinks=t.devices=r;t.sinks.list=[];t.singleton=function(){var e=t.apply(null,arguments);t.singleton=function(){return e};return e};e.Sink=t;return t}(function(){return this}());void function(e){function t(){var e;for(e in t.prototype){if(t.prototype.hasOwnProperty(e)){this[e]=t.prototype[e]}}this._listeners={}}t.prototype={_listeners:null,emit:function(e,t){if(this._listeners[e]){for(var n=0;n<this._listeners[e].length;n++){this._listeners[e][n].apply(this,t)}}return this},on:function(e,t){this._listeners[e]=this._listeners[e]||[];this._listeners[e].push(t);return this},off:function(e,t){if(this._listeners[e]){if(!t){delete this._listeners[e];return this}for(var n=0;n<this._listeners[e].length;n++){if(this._listeners[e][n]===t){this._listeners[e].splice(n--,1)}}if(!this._listeners[e].length){delete this._listeners[e]}}return this}};e.EventEmitter=t;t.call(e)}(this.Sink);void function(e){e.doInterval=function(t,n){function s(s){if(e.inlineWorker.working&&!s){r=e.inlineWorker('setInterval(function (){ postMessage("tic"); }, '+n+");");r.onmessage=function(){t()};i=function(){r.terminate()}}else{r=setInterval(t,n);i=function(){clearInterval(r)}}}var r,i;if(e.inlineWorker.ready){s()}else{e.inlineWorker.on("ready",function(){s()})}return function(){if(!i){if(!e.inlineWorker.ready){e.inlineWorker.on("ready",function(){if(i)i()})}}else{i()}}}}(this.Sink);void function(e){var t,n,r,i;void function(e,s){function o(e,t){var n,r=t.slice();for(n=r.shift();typeof n!=="undefined";n=r.shift()){n=Function("return typeof "+n+e+'=== "undefined" ? undefined : '+n+e)();if(n)return n}}t=o("Blob",e);n=o("BlobBuilder",e);r=o("URL",s);i=o("btoa",[""])}(["","Moz","WebKit","MS"],["","webkit"]);var s=t&&r&&function(e,n){return r.createObjectURL(new t([e],{type:n}))};var o=n&&r&&function(e,t){var i=new n;i.append(e);return r.createObjectURL(i.getBlob(t))};var u=i&&function(e,t){return"data:"+t+";base64,"+i(e)};var a=s||o||u;if(!a)return;if(s)a.createBlob=s;if(o)a.createBlobBuilder=o;if(u)a.createData=u;if(t)a.Blob=t;if(n)a.BlobBuilder=n;if(r)a.URL=r;e.createDynURL=a;e.revokeDynURL=function(e){if(typeof e==="string"&&e.indexOf("data:")===0){return false}else{return r.revokeObjectURL(e)}}}(this.Sink);void function(e){function t(e){if(!t.hasOwnProperty(e))throw t(1);if(!(this instanceof t))return new t(e);var n;for(n in t[e]){if(t[e].hasOwnProperty(n)){this[n]=t[e][n]}}this.code=e}t.prototype=new Error;t.prototype.toString=function(){return"SinkError 0x"+this.code.toString(16)+": "+this.message};t[1]={message:"No such error code.",explanation:"The error code does not exist."};t[2]={message:"No audio sink available.",explanation:"The audio device may be busy, or no supported output API is available for this browser."};t[16]={message:"Buffer underflow.",explanation:"Trying to recover..."};t[17]={message:"Critical recovery fail.",explanation:"The buffer underflow has reached a critical point, trying to recover, but will probably fail anyway."};t[18]={message:"Buffer size too large.",explanation:"Unable to allocate the buffer due to excessive length, please try a smaller buffer. Buffer size should probably be smaller than the sample rate."};e.Error=t}(this.Sink);void function(e){function n(){t(this,"terminate",this._terminate);e.revokeDynURL(this._url);delete this._url;delete this._terminate;return this.terminate()}function r(i){function s(e,i,s){try{var o=e(i,"text/javascript");var u=new Worker(o);t(u,"_url",o);t(u,"_terminate",u.terminate);t(u,"terminate",n);if(r.type)return u;r.type=s;r.createURL=e;return u}catch(a){return null}}var o=e.createDynURL;var u;if(r.createURL){return s(r.createURL,i,r.type)}u=s(o.createBlob,i,"blob");if(u)return u;u=s(o.createBlobBuilder,i,"blobbuilder");if(u)return u;u=s(o.createData,i,"data");return u}var t=Object.defineProperty?function(e,t,n){Object.defineProperty(e,t,{value:n,configurable:true,writable:true})}:function(e,t,n){e[t]=n};e.EventEmitter.call(r);r.test=function(){function n(t){if(r.ready)return;r.ready=true;r.working=t;r.emit("ready",[t]);r.off("ready");if(t&&e){e.terminate()}e=null}r.ready=r.working=false;r.type="";r.createURL=null;var e=r("this.onmessage=function(e){postMessage(e.data)}");var t="inlineWorker";if(!e){setTimeout(function(){n(false)},0)}else{e.onmessage=function(e){n(e.data===t)};e.postMessage(t);setTimeout(function(){n(false)},1e3)}};e.inlineWorker=r;r.test()}(this.Sink);void function(e){e.sinks("audiodata",function(){function c(){if(r){s=i.mozWriteAudio(r);n+=s;if(s<r.length){r=r.subarray(s);return r}r=null}o=i.mozCurrentSampleOffset();u=Number(o+(f!==o?t.bufferSize:t.preBufferSize)*t.channelCount-n);if(o===f){t.emit("error",[e.Error(16)])}if(u>0||f===o){t.ready();try{a=new Float32Array(f===o?t.preBufferSize*t.channelCount:t.forceBufferSize?u<t.bufferSize*2?t.bufferSize*2:u:u)}catch(l){t.emit("error",[e.Error(18)]);t.kill();return}t.process(a,t.channelCount);s=t._audio.mozWriteAudio(a);if(s<a.length){r=a.subarray(s)}n+=s}f=o}var t=this,n=0,r=null,i=new Audio,s,o,u,a,f,l;t.start.apply(t,arguments);t.preBufferSize=isNaN(arguments[4])||arguments[4]===null?this.preBufferSize:arguments[4];i.mozSetup(t.channelCount,t.sampleRate);this._timers=[];this._timers.push(e.doInterval(function(){if(+(new Date)-t.previousHit>2e3){t._audio=i=new Audio;i.mozSetup(t.channelCount,t.sampleRate);n=0;t.emit("error",[e.Error(17)])}},1e3));this._timers.push(e.doInterval(c,t.interval));t._bufferFill=c;t._audio=i},{bufferSize:24576,preBufferSize:24576,forceBufferSize:false,interval:100,kill:function(){while(this._timers.length){this._timers.shift()()}this.emit("kill")},getPlaybackTime:function(){return this._audio.mozCurrentSampleOffset()/this.channelCount}},false,true);e.sinks.moz=e.sinks.audiodata}(this.Sink);void function(e){e.sinks("dummy",function(){function n(){var e=new Float32Array(t.bufferSize*t.channelCount);t.process(e,t.channelCount)}var t=this;t.start.apply(t,arguments);t._kill=e.doInterval(n,t.bufferSize/t.sampleRate*1e3);t._callback=n},{kill:function(){this._kill();this.emit("kill")}},true)}(this.Sink);(function(e,t){function n(e){var t=document.createElement("audio");if(e){t.src=e}return t}function r(){var e=this;e.currentFrame=n();e.nextFrame=n();e._onended=function(){e.samples+=e.bufferSize;e.nextClip()}}t=e.sinks;t("wav",function(){function a(){if(r._audio.hasNextFrame)return;r.ready();e.memcpy(u,0,o,0);r.process(o,r.channelCount);r._audio.setSource("data:audio/wav;base64,"+btoa(audioLib.PCMData.encode({data:o,sampleRate:r.sampleRate,channelCount:r.channelCount,bytesPerSample:r.quality})));if(!r._audio.currentFrame.src)r._audio.nextClip()}var r=this,i=new t.wav.wavAudio,s=typeof s==="undefined"?audioLib.PCMData:s;r.start.apply(r,arguments);var o=new Float32Array(r.bufferSize*r.channelCount),u=new Float32Array(r.bufferSize*r.channelCount);if(!n().canPlayType("audio/wav; codecs=1")||!btoa)throw 0;r.kill=e.doInterval(a,40);r._bufferFill=a;r._audio=i},{quality:1,bufferSize:22050,getPlaybackTime:function(){var e=this._audio;return(e.currentFrame?e.currentFrame.currentTime*this.sampleRate:0)+e.samples}});r.prototype={samples:0,nextFrame:null,currentFrame:null,_onended:null,hasNextFrame:false,nextClip:function(){var e=this.currentFrame;this.currentFrame=this.nextFrame;this.nextFrame=e;this.hasNextFrame=false;this.currentFrame.play()},setSource:function(e){this.nextFrame.src=e;this.nextFrame.addEventListener("ended",this._onended,true);this.hasNextFrame=true}};t.wav.wavAudio=r})(this.Sink);(function(e,t){var n=typeof window==="undefined"?null:window.webkitAudioContext||window.AudioContext;e("webaudio",function(n,r,i,s){function c(e){var t=e.outputBuffer,n=t.numberOfChannels,r,i,s=t.length,u=t.size,a=new Array(n),c;o.ready();f=f&&f.length===s*n?f:new Float32Array(s*n);l=l&&l.length===f.length?l:new Float32Array(s*n);f.set(l);for(r=0;r<n;r++){a[r]=t.getChannelData(r)}o.process(f,o.channelCount);for(r=0;r<s;r++){for(i=0;i<n;i++){a[i][r]=f[r*o.channelCount+i]}}}var o=this,u=e.webaudio.getContext(),a=null,f=null,l=null;o.start.apply(o,arguments);a=u.createScriptProcessor(o.bufferSize,o.channelCount,o.channelCount);o.sampleRate=u.sampleRate;a.onaudioprocess=c;a.connect(u.destination);o._context=u;o._node=a;o._callback=c;t.push(a)},{kill:function(){this._node.disconnect(0);for(var e=0;e<t.length;e++){if(t[e]===this._node){t.splice(e--,1)}}this._node=this._context=null;this.emit("kill")},getPlaybackTime:function(){return this._context.currentTime*this.sampleRate}},false,true);e.webkit=e.webaudio;e.webaudio.fix82795=t;e.webaudio.getContext=function(){var t=new n;e.webaudio.getContext=function(){return t};return t}})(this.Sink.sinks,[]);(function(e){e.sinks("worker",function(){function s(t){if(!e.isReady){e.initMSP(t)}e.ready();var s=e.channelCount,o=t.audioLength,u,a;n=n&&n.length===o*s?n:new Float32Array(o*s);r=r&&r.length===n.length?r:new Float32Array(o*s);i=i&&i.length===n.length?i:new Float32Array(o*s);n.set(i);r.set(i);e.process(n,e.channelCount);for(u=0;u<s;u++){for(a=0;a<o;a++){r[u*t.audioLength+a]=n[u+a*s]}}t.writeAudio(r)}function o(t){if(!e.isReady){e.initWA(t)}e.ready();var r=t.outputBuffer,s=r.numberOfChannels,o,u,a=r.length,f=r.size,l=new Array(s),c;n=n&&n.length===a*s?n:new Float32Array(a*s);i=i&&i.length===n.length?i:new Float32Array(a*s);n.set(i);for(o=0;o<s;o++){l[o]=r.getChannelData(o)}e.process(n,e.channelCount);for(o=0;o<a;o++){for(u=0;u<s;u++){l[u][o]=n[o*e.channelCount+u]}}}var e=this,t=function(){return this}(),n=null,r=null,i=null;e.start.apply(e,arguments);importScripts();t.onprocessmedia=s;t.onaudioprocess=o;e._mspBufferFill=s;e._waBufferFill=o},{ready:false,initMSP:function(e){this.channelCount=e.audioChannels;this.sampleRate=e.audioSampleRate;this.bufferSize=e.audioLength*this.channelCount;this.ready=true;this.emit("ready",[])},initWA:function(e){var t=e.outputBuffer;this.channelCount=t.numberOfChannels;this.sampleRate=t.sampleRate;this.bufferSize=t.length*this.channelCount;this.ready=true;this.emit("ready",[])}})})(this.Sink);(function(e){e.deinterleave=function(e,t){var n=e.length,r=n/t,i=[],s,o;for(s=0;s<t;s++){i[s]=new Float32Array(r);for(o=0;o<r;o++){i[s][o]=e[o*t+s]}}return i};e.interleave=function(e,t,n){t=t||e.length;var r=e[0].length,i=e.length,s,o;n=n||new Float32Array(r*t);for(s=0;s<i;s++){for(o=0;o<r;o++){n[s+o*t]=e[s][o]}}return n};e.mix=function(e){var t=[].slice.call(arguments,1),n,r,i;for(i=0;i<t.length;i++){n=Math.max(e.length,t[i].length);for(r=0;r<n;r++){e[r]+=t[i][r]}}return e};e.resetBuffer=function(e){var t=e.length,n;for(n=0;n<t;n++){e[n]=0}return e};e.clone=function(e,t){var n=e.length,r;t=t||new Float32Array(n);for(r=0;r<n;r++){t[r]=e[r]}return t};e.createDeinterleaved=function(e,t){var n=new Array(t),r;for(r=0;r<t;r++){n[r]=new Float32Array(e)}return n};e.memcpy=function(e,t,n,r,i){e=e.subarray||e.slice?e:e.buffer;n=n.subarray||n.slice?n:n.buffer;e=t?e.subarray?e.subarray(t,i&&t+i):e.slice(t,i&&t+i):e;if(n.set){n.set(e,r)}else{for(var s=0;s<e.length;s++){n[s+r]=e[s]}}return n};e.memslice=function(e,t,n){return e.subarray?e.subarray(t,n):e.slice(t,n)};e.mempad=function(t,n,r){n=n.length?n:new t.constructor(n);e.memcpy(t,0,n,r);return n};e.linspace=function(e,t,n){var r,i,s,o;n=n.length?(r=n.length)&&n:Array(r=n);o=(t-e)/--r;for(s=e+o,i=1;i<r;i++,s+=o){n[i]=s}n[0]=e;n[r]=t;return n};e.ftoi=function(e,t,n){var r,i=Math.pow(2,t-1);n=n||new e.constructor(e.length);for(r=0;r<e.length;r++){n[r]=~~(i*e[r])}return n}})(this.Sink);(function(e){function t(t,n){e.EventEmitter.call(this);this.bufferSize=isNaN(t)||t===null?this.bufferSize:t;this.channelCount=isNaN(n)||n===null?this.channelCount:n;var r=this;this.callback=function(){return r.process.apply(r,arguments)};this.resetBuffer()}t.prototype={buffer:null,zeroBuffer:null,parentSink:null,bufferSize:4096,channelCount:2,offset:null,resetBuffer:function(){this.buffer=new Float32Array(this.bufferSize);this.zeroBuffer=new Float32Array(this.bufferSize)},process:function(e,t){if(this.offset===null){this.loadBuffer()}for(var n=0;n<e.length;n++){if(this.offset>=this.buffer.length){this.loadBuffer()}e[n]=this.buffer[this.offset++]}},loadBuffer:function(){this.offset=0;e.memcpy(this.zeroBuffer,0,this.buffer,0);this.emit("audioprocess",[this.buffer,this.channelCount])}};e.Proxy=t;e.prototype.createProxy=function(t){var n=new e.Proxy(t,this.channelCount);n.parentSink=this;this.on("audioprocess",n.callback);return n}})(this.Sink);(function(e){(function(){function t(n,r){if(n&&r){t[n]=r}else if(n&&t[n]instanceof Function){e.interpolate=t[n]}return t[n]}e.interpolation=t;t("linear",function(e,t){var n=Math.floor(t),r=n+1,i=t-n;r=r<e.length?r:0;return e[n]*(1-i)+e[r]*i});t("nearest",function(e,t){return t>=e.length-.5?e[0]:e[Math.round(t)]});t("linear")})();e.resample=function(t,n,r,i,s){var o=arguments.length,u=o===2?n:o===3?n/r:i/n*s/r,a=t.length,f=Math.ceil(a/u),l=new Float32Array(f),c,h;for(c=0,h=0;c<a;c+=u){l[h++]=e.interpolate(t,c)}return l}})(this.Sink);void function(e){function t(e){this.boundTo=e;this.buffers=[];e.activeRecordings.push(this)}e.on("init",function(e){e.activeRecordings=[];e.on("postprocess",e.recordData)});e.prototype.activeRecordings=null;e.prototype.record=function(){var t=new e.Recording(this);this.emit("record",[t]);return t};e.prototype.recordData=function(e){var t=this.activeRecordings,n,r=t.length;for(n=0;n<r;n++){t[n].add(e)}};t.prototype={add:function(e){this.buffers.push(e)},clear:function(){this.buffers=[]},stop:function(){var e=this.boundTo.activeRecordings,t;for(t=0;t<e.length;t++){if(e[t]===this){e.splice(t--,1)}}},join:function(){var e=0,t=0,n=this.buffers,r,i,s,o=n.length;for(s=0;s<o;s++){e+=n[s].length}r=new Float32Array(e);for(s=0;s<o;s++){for(i=0;i<n[s].length;i++){r[t+i]=n[s][i]}t+=n[s].length}return r}};e.Recording=t}(this.Sink);void function(e){function t(){if(this.ringBuffer){(this.channelMode==="interleaved"?this.ringSpin:this.ringSpinInterleaved).apply(this,arguments)}}e.on("init",function(e){e.on("preprocess",t)});e.prototype.ringBuffer=null;e.prototype.ringSpin=function(e){var t=this.ringBuffer,n=e.length,r=t.length,i=this.ringOffset,s;for(s=0;s<n;s++){e[s]+=t[i];i=(i+1)%r}this.ringOffset=i};e.prototype.ringSpinDeinterleaved=function(e){var t=this.ringBuffer,n=e.length,r=t.length,i=t[0].length,s=r*i,o=this.ringOffset,u,a;for(u=0;u<n;u+=r){for(a=0;a<r;a++){e[u+a]+=t[a][o]}o=(o+1)%i}this.ringOffset=a}}(this.Sink);void function(e,t){t=e.prototype;e.on("init",function(e){e.asyncBuffers=[];e.syncBuffers=[];e.on("preprocess",e.writeBuffersSync);e.on("postprocess",e.writeBuffersAsync)});t.writeMode="async";t.asyncBuffers=t.syncBuffers=null;t.writeBuffersAsync=function(e){var t=this.asyncBuffers,n=e.length,r,i,s,o,u;if(t){for(s=0;s<t.length;s++){r=t[s];i=r.b.length;u=r.d;r.d-=Math.min(u,n);for(o=0;o+u<n&&o<i;o++){e[o+u]+=r.b[o]}r.b=r.b.subarray(o+u);if(s>=i){t.splice(s--,1)}}}};t.writeBuffersSync=function(e){var t=this.syncBuffers,n=e.length,r=0,i=0;for(;r<n&&t.length;r++){e[r]+=t[0][i];if(t[0].length<=i){t.splice(0,1);i=0;continue}i++}if(t.length){t[0]=t[0].subarray(i)}};t.writeBufferAsync=function(t,n){t=this.mode==="deinterleaved"?e.interleave(t,this.channelCount):t;var r=this.asyncBuffers;r.push({b:t,d:isNaN(n)?~~((+(new Date)-this.previousHit)/1e3*this.sampleRate):n});return r.length};t.writeBufferSync=function(t){t=this.mode==="deinterleaved"?e.interleave(t,this.channelCount):t;var n=this.syncBuffers;n.push(t);return n.length};t.writeBuffer=function(){return this[this.writeMode==="async"?"writeBufferAsync":"writeBufferSync"].apply(this,arguments)};t.getSyncWriteOffset=function(){var e=this.syncBuffers,t=0,n;for(n=0;n<e.length;n++){t+=e[n].length}return t}}(this.Sink)
